<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vio-&gt;vision_pose | 整理的知识库</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Starter template for a VuePress project - including CI for GH Pages hosting">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.7c8934a5.css" as="style"><link rel="preload" href="/assets/js/app.6d198f1d.js" as="script"><link rel="preload" href="/assets/js/2.b95ab0d4.js" as="script"><link rel="preload" href="/assets/js/1.f6aabd51.js" as="script"><link rel="preload" href="/assets/js/33.6c2cf308.js" as="script"><link rel="prefetch" href="/assets/js/10.da99f91e.js"><link rel="prefetch" href="/assets/js/11.fb29814a.js"><link rel="prefetch" href="/assets/js/12.dcd6975f.js"><link rel="prefetch" href="/assets/js/13.664b4e1f.js"><link rel="prefetch" href="/assets/js/14.fbd642a5.js"><link rel="prefetch" href="/assets/js/15.553d0dc9.js"><link rel="prefetch" href="/assets/js/16.b9da07d3.js"><link rel="prefetch" href="/assets/js/17.d28cd808.js"><link rel="prefetch" href="/assets/js/18.5adb74f5.js"><link rel="prefetch" href="/assets/js/19.fbf09d3f.js"><link rel="prefetch" href="/assets/js/20.baeb890a.js"><link rel="prefetch" href="/assets/js/21.1ad0ca31.js"><link rel="prefetch" href="/assets/js/22.da80316e.js"><link rel="prefetch" href="/assets/js/23.fcf219bc.js"><link rel="prefetch" href="/assets/js/24.fffa759f.js"><link rel="prefetch" href="/assets/js/25.0521cc8b.js"><link rel="prefetch" href="/assets/js/26.cc085127.js"><link rel="prefetch" href="/assets/js/27.3c7a1991.js"><link rel="prefetch" href="/assets/js/28.83a6bbe8.js"><link rel="prefetch" href="/assets/js/29.8120d476.js"><link rel="prefetch" href="/assets/js/3.e08a0bbc.js"><link rel="prefetch" href="/assets/js/30.e57deda6.js"><link rel="prefetch" href="/assets/js/31.41e6fb06.js"><link rel="prefetch" href="/assets/js/32.6a160d46.js"><link rel="prefetch" href="/assets/js/34.b378bfc5.js"><link rel="prefetch" href="/assets/js/4.bf78d947.js"><link rel="prefetch" href="/assets/js/5.55af9590.js"><link rel="prefetch" href="/assets/js/6.5d247747.js"><link rel="prefetch" href="/assets/js/7.baaa9855.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.77260563.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7c8934a5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">整理的知识库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><a href="/config/" class="nav-link">
  Config
</a></div><div class="nav-item"><a href="https://v1.vuepress.vuejs.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><a href="/config/" class="nav-link">
  Config
</a></div><div class="nav-item"><a href="https://v1.vuepress.vuejs.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/guide/using-vue.html" class="sidebar-link">Using Vue in Markdown</a></li><li><a href="/guide/vio2vision_pose.html" aria-current="page" class="active sidebar-link">vio-&gt;vision_pose</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/vio2vision_pose.html#现象-vio-接入-vision-pose-就崩掉" class="sidebar-link">现象: VIO 接入 vision_pose 就崩掉</a></li><li class="sidebar-sub-header"><a href="/guide/vio2vision_pose.html#消除bias" class="sidebar-link">消除bias</a></li><li class="sidebar-sub-header"><a href="/guide/vio2vision_pose.html#去掉-offset-估计" class="sidebar-link">去掉 offset 估计</a></li><li class="sidebar-sub-header"><a href="/guide/vio2vision_pose.html#practise" class="sidebar-link">Practise</a></li><li class="sidebar-sub-header"><a href="/guide/vio2vision_pose.html#参考源码与文档" class="sidebar-link">参考源码与文档</a></li><li class="sidebar-sub-header"><a href="/guide/vio2vision_pose.html#vio-输出作为-vision-pose" class="sidebar-link">VIO 输出作为 vision_pose</a></li></ul></li><li><a href="/guide/use_mavros.html" class="sidebar-link">mavros</a></li><li><a href="/guide/edge_firmware.html" class="sidebar-link">Vim Edge2 固件编译</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vio-vision-pose"><a href="#vio-vision-pose" class="header-anchor">#</a> vio-&gt;vision_pose</h1> <blockquote><p>以下是 debug 过程</p></blockquote> <ul><li>原来的控制方法不够稳定，体现在当状态不好时悬停都十分困难。</li> <li>测试这个是因为ego_planner带的控制没有很好的跟踪轨迹，有时候期望和目标位置能差20cm,躲障碍时问题就很大，就想试试直接发p a v 给px4</li></ul> <h2 id="现象-vio-接入-vision-pose-就崩掉"><a href="#现象-vio-接入-vision-pose-就崩掉" class="header-anchor">#</a> <strong>现象</strong>: VIO 接入 vision_pose 就崩掉</h2> <p>阅读了源码，发现:</p> <ul><li>早先的测试中，6c 跑vins几乎没有正常过，莫名其妙的飘，原因基本可以确定是地磁的原因，vins拿到的imu数据被px4中的EKF做了处理(EKF对传感器数据修正)，因此磁场差的时候vins就会崩掉，把罗盘关掉直接就好了。</li> <li>这种机制造成了一个问题，如果把vins的数据作为vision_pose 发给px4 ,让px4做EKF，会崩掉，我在固件中将对EKF对imU数据修正的处理去掉后，就不再崩了。</li></ul> <h2 id="消除bias"><a href="#消除bias" class="header-anchor">#</a> 消除bias</h2> <p>修改固件后VINS精度变差的原因排查，猜测原因如下</p> <ul><li>传感器校准</li> <li>外参z轴没有标定好 (猜测是主要原因)</li> <li>原来的EKF对Z轴的精度提升有影响，也许融合了气压计的值</li></ul> <p>始终没有将VINS标定到一个非常合适的值</p> <h2 id="去掉-offset-估计"><a href="#去掉-offset-估计" class="header-anchor">#</a> 去掉 offset 估计</h2> <h3 id="飞行状态变差"><a href="#飞行状态变差" class="header-anchor">#</a> 飞行状态变差</h3> <p>尝试了控制定点非常稳定，但是发现画不了圆(掉高，完全称不上是圆)。</p> <p><a href="https://docs.px4.io/main/en/ros/mavros_offboard_cpp.html" target="_blank" rel="noopener noreferrer">MAVROS Offboard control example (C++) | PX4 User Guide<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="结论"><a href="#结论" class="header-anchor">#</a> 结论</h3> <ol><li><p>由于VIO的 数据来源data_raw 的数据被 EKF处理过，所以不能将VIO计算出的位姿信息反给飞控做EKF。</p></li> <li><p>可以修改固件使得data_raw 不被EKF处理，但是这样会出现两个隐患</p> <ol><li>很难标定到一个非常好的外参，感觉每次都会有一些变化(直观感受)</li> <li>手举着飞机时感觉一切正常，但是飞起来后效果就差很多了，除了悬停很稳外，剩下的几乎不可用。</li></ol></li> <li><p>可以只用双目来解决 2.b出现的问题，但是飘的太快了，特别是高度（一个来回飘1m）。</p></li> <li><p>由1,2,3 可推测</p> <ol><li>data_raw 不是真正的raw，校正的意义是比较大的。</li> <li>真正的raw效果并不好
如果实在想实现，可能必须要移植滤波算法了。</li></ol></li> <li><p>可以使用一个临时的解决方法，两个飞控，一个专门用来飞行，一个专门作为VIO的数据源，看起来非常的笨，但是实测效果很不错，完全可用。</p></li> <li><p>因此先用 5.的方法实现多机，写一些脚本使得使用简单一些，同时购买挑选合适的IMU，有机会也真正测一下D435i上的IMU吧。</p></li></ol> <h1 id="pva-参数调试"><a href="#pva-参数调试" class="header-anchor">#</a> PVA 参数调试</h1> <h2 id="practise"><a href="#practise" class="header-anchor">#</a> Practise</h2> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">//不能这样写，注意坐标系</span>
mpCtrl<span class="token punctuation">.</span>type_mask <span class="token operator">=</span> mpCtrl<span class="token punctuation">.</span>IGNORE_YAW_RATE<span class="token operator">|</span>mpCtrl<span class="token punctuation">.</span>IGNORE_AFY<span class="token operator">|</span>mpCtrl<span class="token punctuation">.</span>IGNORE_VY<span class="token punctuation">;</span>

</code></pre></div><p><a href="http://docs.ros.org/en/api/mavros_msgs/html/msg/PositionTarget.html" target="_blank" rel="noopener noreferrer">mavros_msgs/PositionTarget Documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>MPC_XY_P 0.95→1.2</p> <p>MPC_XY_VEL_P_ACC 1.8→1.2</p> <p>修改 MPC_JERK_AUTO -&gt; default 4 -&gt;15</p> <h2 id="参考源码与文档"><a href="#参考源码与文档" class="header-anchor">#</a> 参考源码与文档</h2> <p>对比了源码与文档，有了新的发现</p> <p>[[px4 - Multicopter Position Control 细究]]</p> <h2 id="vio-输出作为-vision-pose"><a href="#vio-输出作为-vision-pose" class="header-anchor">#</a> VIO 输出作为 vision_pose</h2> <p>这两天有一些其他的进展，之前vins飘的原因应该算完全找到了，vins拿到的imu数据被px4中的EKF做了处理(EKF对传感器数据修正)，因此磁场差的时候vins就会崩掉，把罗盘关掉直接就好了。 这种机制造成了一个问题，如果把vins的数据作为vision_pose 发给px4 ,让px4做EKF，会崩掉，我在固件中将对EKF对imU数据修正的处理去掉后，就不再崩了。（研究这个是因为ego_planner带的控制没有很好的跟踪轨迹，有时候期望和目标位置能差20cm,躲障碍时问题就很大，就想试试直接发p a v 给px4，然后发现了这个问题）
但是 这样的VINS效果并不好，特别是飞机飞起来的时候。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/using-vue.html" class="prev">
        Using Vue in Markdown
      </a></span> <span class="next"><a href="/guide/use_mavros.html">
        mavros
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6d198f1d.js" defer></script><script src="/assets/js/2.b95ab0d4.js" defer></script><script src="/assets/js/1.f6aabd51.js" defer></script><script src="/assets/js/33.6c2cf308.js" defer></script>
  </body>
</html>
